#!/usr/bin/env ruby
#
# Display current exchange rates for RSD.
# $ kurs [eur|usd|chf|...]*

require "open-uri"
require "json"
require "yaml"

module Kurs
  module API
    KEY = ENV["API_KEY_KURSNA_LISTA"] or abort "Missing API key, aborting."
    URL = "https://api.kursna-lista.info/#{KEY}/kursna_lista/json"

    def self.fetch
      open(URL).read
    end
  end

  CACHE_KEY = ["kurs", Time.now.strftime("%Y-%m-%d")].join("-")
  CACHE_FILE = "/tmp/#{CACHE_KEY}.json"
  DEFAULT_CURRENCIES = %w[eur usd]

  module_function

  def raw
    File.read(CACHE_FILE)
  rescue Errno::ENOENT
    API.fetch.tap { |data| File.write(CACHE_FILE, data) }
  end

  def list
    JSON.parse(raw)["result"]
  end

  def filter(*currencies)
    currencies = DEFAULT_CURRENCIES if currencies.empty?
    list.select { |c| currencies.include? c }
  end

  def pretty(*currencies)
    filter(*currencies).to_yaml.delete("'-").strip
  end
end

puts Kurs.pretty(*ARGV) if __FILE__ == $0
